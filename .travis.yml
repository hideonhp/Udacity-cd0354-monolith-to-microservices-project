version: ~> 1.0

jobs:
  include:
    - stage: Build and Push Docker Images
      name: Build and Push Docker Images
      language: minimal
      services:
        - docker
      before_install:
        - docker --version
      install: skip
      script:
        - docker build -t udagram-api-feed ./udagram-api-feed
        - docker build -t udagram-api-user ./udagram-api-user
        - docker build -t udagram-reverseproxy ./udagram-reverseproxy
        - docker build -t udagram-frontend ./udagram-frontend
        - docker tag udagram-api-feed hideonhp/udagram-api-feed:v1.2
        - docker tag udagram-api-user hideonhp/udagram-api-user:v1.2
        - docker tag udagram-reverseproxy hideonhp/udagram-reverseproxy:v1.2
        - docker tag udagram-frontend hideonhp/udagram-frontend:v2.0
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push hideonhp/udagram-api-feed:v1.2
        - docker push hideonhp/udagram-api-user:v1.2
        - docker push hideonhp/udagram-reverseproxy:v1.2
        - docker push hideonhp/udagram-frontend:v2.0
      if:
        branch = main
